function CoverCanvasBox(t){this.FIELDS=["padding","x","y","w","h","z"],this.id=0,this.bw=240,this.bh=135,this.padding=3,this.title="",this.titleH=45,this.x=0,this.y=0,this.w=1,this.h=1,this.z=0,this.target={x:0,xStep:0,y:0,yStep:0,w:1,wStep:0,h:1,hStep:0,z:0,zStep:0},this.color="#666",this.boxBg="#fff",this.thumb="",this.url="",this.callback=null;for(const i in t)this[i]=t[i];this.canvas=null,this.canvasR=null}function CoverList(t){if(this.widgetPlace="#cover_list",this.yOffset=-10,this.padding=3,this.boxWidth=240+2*this.padding,this.boxHeight=135+2*this.padding,this.minSize=.8,this.selected=-1,this.color="#666",this.boxBg="#fff",this.widgetElement=null,this.widgetWidth=0,this.widgetHeight=0,this.rangeInput=null,this.elements=[],this.positions=[],this.animation={duration:200,interval:25,currentTime:0},jsu.setObjectAttributes(this,t,["widgetPlace","padding","boxWidth","boxHeight","minSize","selected","color","boxBg"]),t&&t.elements)for(let i=0;i<t.elements.length;i++)this.addElement(t.elements[i]);"-"==this.color&&(this.color="transparent"),jsu.onDOMLoad(this.initCoverList.bind(this))}CoverCanvasBox.prototype.loadImage=function(){if(!this.thumb)return void this.onLoad(null,!1);const t=new Image;if(null!=this.callback){const i=this;t.onload=function(){i.onLoad(this)},t.onabort=function(){i.onLoad(this)},t.onerror=function(){i.onLoad(null)}}t.src=this.thumb},CoverCanvasBox.prototype.onLoad=function(t){this.canvas=document.createElement("canvas"),this.canvas.width=this.bw,this.canvas.height=this.bh;const i=this.bw-2*this.padding,e=this.bh-2*this.padding,s=this.canvas.getContext("2d");if(s.fillStyle=this.color,s.fillRect(0,0,this.bw,this.bh),s.fillStyle=this.boxBg,s.fillRect(this.padding,this.padding,i,e),t){const h=t.width/t.height;let o=t.width,n=t.height;o>i&&(o=i,n=i/h),n>e&&(n=e,o=e*h),s.drawImage(t,this.padding+Math.floor((i-o)/2),this.padding+Math.floor((e-n)/2),o,n)}if(this.title){s.fillStyle="rgba(0, 0, 0, 0.8)",s.fillRect(this.padding,this.padding+e-this.titleH,i,this.titleH);const t=16;s.font="italic "+t+"px Arial",s.fillStyle="#fff",s.textAlign="center",s.textBaseline="middle";const h=this.padding+Math.floor(i/2);let o;const n=i-10;let a="",l="",r=!0;if(s.measureText(this.title).width>n){const t=this.title.split(" ");let i=t.length;for(let e=0;e<i;e++){const i=t[0];if(s.measureText(a+" "+i).width>n){if(!a)for(let t=0;t<i.length;t++){if(s.measureText(a+i[t]).width>n-20){a+=" ...",r=!1;break}a+=i[t]}break}a+=" "+i,t.shift()}if(r){i=t.length;for(let e=0;e<i;e++){const i=t[0];if(s.measureText(l+" "+i).width>n-20){if(l)l+=" ...";else for(let t=0;t<i.length;t++){if(s.measureText(l+i[t]).width>n-20){l+=" ...";break}l+=i[t]}break}l+=" "+i,t.shift()}}}else a=this.title;a&&l?(o=this.padding+e-Math.floor((this.titleH+t)/2),s.fillText(a,h,o),o+=4+t,s.fillText(l,h,o)):(o=this.padding+e-Math.floor(this.titleH/2),s.fillText(a,h,o))}s.save(),this.canvasR=document.createElement("canvas"),this.canvasR.width=this.bw,this.canvasR.height=this.bh;const h=this.canvasR.getContext("2d");h.drawImage(this.canvas,0,0,this.bw,this.bh);const o=h.createLinearGradient(0,0,0,this.bh);o.addColorStop(0,"rgba(0, 0, 0, 1)"),o.addColorStop(.5,"rgba(0, 0, 0, 1)"),o.addColorStop(1,"rgba(0, 0, 0, 0.7)"),h.globalCompositeOperation="destination-out",h.fillStyle=o,h.fillRect(0,0,this.bw,this.bh),null!=this.callback&&this.callback(this.id,!1)},CoverCanvasBox.prototype.setTarget=function(t){const i=t.steps?t.steps:50;for(let e=0;e<this.FIELDS.length;e++){const s=this.FIELDS[e];s in t?(this.target[s]=t[s],this.target[s+"_step"]=(this.target[s]-this[s])/i):(this.target[s]=this[s],this.target[s+"_step"]=0)}},CoverCanvasBox.prototype.increment=function(){for(let t=0;t<this.FIELDS.length;t++){const i=this.FIELDS[t];this[i]!=this.target[i]&&(this[i]+=this.target[i+"_step"])}},CoverCanvasBox.prototype.draw=function(t){this.canvas&&(t.clearRect(this.x,this.y,this.w,2*this.h),t.drawImage(this.canvas,this.x,this.y,this.w,this.h),t.save(),t.scale(1,-1),t.drawImage(this.canvasR,this.x,-this.y-2*this.h,this.w,this.h),t.restore())},CoverCanvasBox.prototype.contains=function(t,i){return t>=this.x&&t<=this.x+this.w&&i>=this.y&&i<=this.y+this.h},CoverList.prototype.addElement=function(t){const i={index:this.elements.length,title:"No title",thumb:"",url:""};for(const e in t)i[e]=t[e];this.elements.push(i)},CoverList.prototype.initCoverList=function(){this.selected<0?this.selected=Math.floor(this.elements.length/2):this.selected>=this.elements.length&&(this.selected=this.elements.length-1);let t="";for(const i of this.elements)t+='<li><a href="'+jsu.escapeAttribute(i.url)+'">'+jsu.escapeHTML(i.title)+"</a></li>";const i='<ul class="cover-alt sr-only">'+t+'</ul><canvas aria-hidden="true"></canvas><div class="cover-loading" aria-hidden="true"><i class="loader"></i></div><div class="cover-bar" aria-hidden="true"'+(this.elements.length<2?' style="display: none;"':"")+'><button type="button" class="cover-previous" aria-hidden="true" title="'+jsu.translate("Previous")+'"><b>&lt;</b></button><div class="cover-slider"><input type="range" role="slider" aria-hidden="true" min="0" max="'+(this.elements.length-1)+'" value="'+this.selected+'" draggable="draggable"/></div><button type="button" class="cover-next" aria-hidden="true" title="'+jsu.translate("Next")+'"><b>&gt;</b></button></div>';this.widgetElement=document.querySelector(this.widgetPlace),this.widgetElement.innerHTML=i,this.widgetElement.classList.add("cover-list"),this.rangeInput=this.widgetElement.querySelector(".cover-slider input"),this.widgetWidth=parseInt(this.widgetElement.clientWidth,10),this.widgetWidth%2!=0&&this.widgetWidth--,this.widgetHeight=parseInt(this.widgetElement.clientHeight,10),this.widgetHeight%2!=0&&this.widgetHeight--,this.calculatePositions();try{this.initCanvas()}catch(t){console.error("Error when trying to initialize cover list.",t)}const e=this;this.widgetElement.querySelector(".cover-previous").addEventListener("click",this.goToPrevious.bind(this)),this.widgetElement.querySelector(".cover-next").addEventListener("click",this.goToNext.bind(this)),this.rangeInput.addEventListener("input",function(){e.goToIndex(this.value)})},CoverList.prototype.calculatePositions=function(){if(0==this.elements.length)this.positions=[];else if(1==this.elements.length){const t=(this.widgetHeight-this.boxHeight)/2+this.yOffset,i=(this.widgetWidth-this.boxWidth)/2;this.positions.push({delta:0,factor:0,width:this.boxWidth,height:this.boxHeight,zindex:1,top:t,offset:i})}else{const t=this.elements.length;let i=1;t<5&&(i=.75,t<3&&(i=.5));for(let e=t;e>=0;e--){const s=t-e;let h=s/t;h=Math.sqrt(h)*i;const o=this.boxWidth*(1-h*this.minSize),n=this.boxHeight*(1-h*this.minSize),a=t-s,l=(this.widgetHeight-n)/2+this.yOffset,r=(this.widgetWidth-o)/2+h*(this.widgetWidth-o)/2;this.positions.push({delta:s,factor:h,width:o,height:n,zindex:a,top:l,offset:r})}}},CoverList.prototype.hideLoading=function(){this.widgetElement.querySelector(".cover-loading").style.display="none"},CoverList.prototype.initCanvas=function(){const t=this.widgetElement.querySelector("canvas");t.setAttribute("width",this.widgetWidth),t.setAttribute("height",this.widgetHeight),this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.boxes=[],this.boxesDict={},this.nbImagesLoaded=0,this.imagesLoaded=!1;const i=this;t.addEventListener("click",function(e){let s=t,h=0,o=0;for(;null!=s&&null!=s;)h+=s.offsetLeft,o+=s.offsetTop,s=s.offsetParent;const n=e.pageX-h,a=e.pageY-o;i.onCanvasClick(n,a)});for(let t=0;t<this.elements.length;t++){const i=this.elements[t],e=t-this.selected,s=this.positions[Math.abs(e)];let h;h=e<0?this.widgetWidth-s.width-s.offset:s.offset,this.addBox(new CoverCanvasBox({id:t,bw:this.boxWidth,bh:this.boxHeight,padding:this.padding,title:i.title,x:h,y:s.top,w:s.width,h:s.height,z:s.zindex,color:this.color,boxBg:this.boxBg,thumb:i.thumb,url:i.url,callback:this.onImageLoad.bind(this)}))}},CoverList.prototype.onImageLoad=function(){this.nbImagesLoaded++,this.nbImagesLoaded>=this.elements.length&&(this.imagesLoaded=!0,this.hideLoading(),this.drawBoxes())},CoverList.prototype.goToPrevious=function(){this.goToIndex(this.selected-1)},CoverList.prototype.goToNext=function(){this.goToIndex(this.selected+1)},CoverList.prototype.goToIndex=function(t){if(t<0||t>this.elements.length-1||t==this.selected)return;this.selected=t;const i=this.animation.duration/this.animation.interval;for(let t=0;t<this.elements.length;t++){const e=t-this.selected,s=this.positions[Math.abs(e)];let h;h=e<0?this.widgetWidth-s.width-s.offset:s.offset,this.boxesDict["box_"+t].setTarget({steps:i,x:h,y:s.top,w:s.width,h:s.height,z:s.zindex,color:this.color})}this.animateMovement(),this.rangeInput.value=this.selected},CoverList.prototype.addBox=function(t){this.boxes.push(t),this.boxesDict["box_"+t.id]=t,t.loadImage()},CoverList.prototype.drawBoxes=function(){this.boxes=this.boxes.sort(function(t,i){return t.z-i.z}),this.ctx.clearRect(0,0,this.width,this.height);for(let t=0;t<this.boxes.length;t++)this.boxes[t].draw(this.ctx)},CoverList.prototype.onCanvasClick=function(t,i){const e=this.boxes.sort(function(t,i){return i.z-t.z});for(let s=0;s<e.length;s++)if(e[s].contains(t,i)){this.selectBox(e[s]);break}},CoverList.prototype.selectBox=function(t){t.id==this.selected?window.location=t.url:this.goToIndex(t.id)},CoverList.prototype.animateMovement=function(){this.animation.currentTime=0,this.animation.timeout=null,this.animateMovementLoop()},CoverList.prototype.animateMovementLoop=function(){if(null!=this.animation.timeout&&(clearTimeout(this.animation.timeout),this.animation.timeout=null),this.animation.currentTime>=this.animation.duration)return;for(let t=0;t<this.boxes.length;t++)this.boxes[t].increment();this.imagesLoaded&&this.drawBoxes(),this.animation.currentTime+=this.animation.interval;const t=this;this.animation.timeout=setTimeout(function(){t.animateMovementLoop()},this.animation.interval)};