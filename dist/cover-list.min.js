function CoverCanvasBox(t){let i;for(i in this.FIELDS=["padding","x","y","w","h","z"],this.id=0,this.bw=240,this.bh=135,this.padding=3,this.title="",this.titleH=45,this.x=0,this.y=0,this.w=1,this.h=1,this.z=0,this.target={x:0,xStep:0,y:0,yStep:0,w:1,wStep:0,h:1,hStep:0,z:0,zStep:0},this.color="#666",this.boxBg="#fff",this.thumb="",this.url="",this.callback=null,t)this[i]=t[i];this.canvas=null}function CoverList(t){if(this.widgetPlace="#cover_list",this.yOffset=-10,this.padding=3,this.boxWidth=240+2*this.padding,this.boxHeight=135+2*this.padding,this.minSize=.8,this.selected=-1,this.color="#666",this.boxBg="#fff",this.sliderLabelId=null,this.widgetElement=null,this.widgetWidth=0,this.widgetHeight=0,this.rangeInput=null,this.elements=[],this.positions=[],this.animation={duration:200,interval:25,currentTime:0},jsu.setObjectAttributes(this,t,["widgetPlace","padding","boxWidth","boxHeight","minSize","selected","color","boxBg","sliderLabelId"]),t&&t.elements)for(let i=0;i<t.elements.length;i++)this.addElement(t.elements[i]);"-"==this.color&&(this.color="transparent");const i=this;jsu.onDOMLoad(function(){i.initCoverList()})}CoverCanvasBox.prototype.loadImage=function(){if(!this.thumb)return void this.onLoad(null,!1);const t=new Image;if(null!=this.callback){const i=this;t.onload=function(){i.onLoad(this,!0)},t.onabort=function(){i.onLoad(this,!0)},t.onerror=function(){i.onLoad(this,!1)}}t.src=this.thumb},CoverCanvasBox.prototype.onLoad=function(t,i){this.canvas=document.createElement("canvas"),this.canvas.width=this.bw,this.canvas.height=this.bh;const e=this.bw-2*this.padding,s=this.bh-2*this.padding,o=this.canvas.getContext("2d");if(o.fillStyle=this.color,o.fillRect(0,0,this.bw,this.bh),o.fillStyle=this.boxBg,o.fillRect(this.padding,this.padding,e,s),i){const i=t.width/t.height;let h=t.width,n=t.height;h>e&&(h=e,n=e/i),n>s&&(n=s,h=s*i),o.drawImage(t,this.padding+Math.floor((e-h)/2),this.padding+Math.floor((s-n)/2),h,n)}if(this.title){o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(this.padding,this.padding+s-this.titleH,e,this.titleH);const t=16;o.font="italic "+t+"px Arial",o.fillStyle="#fff",o.textAlign="center",o.textBaseline="middle";const i=this.padding+Math.floor(e/2);let h;const n=e-10;let a="",l="",r=!0;if(o.measureText(this.title).width>n){const t=this.title.split(" ");let i=t.length;for(let e=0;e<i;e++){const i=t[0];if(o.measureText(a+" "+i).width>n){if(!a)for(let t=0;t<i.length;t++){if(o.measureText(a+i[t]).width>n-20){a+=" ...",r=!1;break}a+=i[t]}break}a+=" "+i,t.shift()}if(r){i=t.length;for(let e=0;e<i;e++){const i=t[0];if(o.measureText(l+" "+i).width>n-20){if(l)l+=" ...";else for(let t=0;t<i.length;t++){if(o.measureText(l+i[t]).width>n-20){l+=" ...";break}l+=i[t]}break}l+=" "+i,t.shift()}}}else a=this.title;a&&l?(h=this.padding+s-Math.floor((this.titleH+t)/2),o.fillText(a,i,h),h+=4+t,o.fillText(l,i,h)):(h=this.padding+s-Math.floor(this.titleH/2),o.fillText(a,i,h))}o.save(),null!=this.callback&&this.callback(this.id,!1)},CoverCanvasBox.prototype.setTarget=function(t){const i=t.steps?t.steps:50;for(let e=0;e<this.FIELDS.length;e++){const s=this.FIELDS[e];s in t?(this.target[s]=t[s],this.target[s+"_step"]=(this.target[s]-this[s])/i):(this.target[s]=this[s],this.target[s+"_step"]=0)}},CoverCanvasBox.prototype.increment=function(){for(let t=0;t<this.FIELDS.length;t++){const i=this.FIELDS[t];this[i]!=this.target[i]&&(this[i]+=this.target[i+"_step"])}},CoverCanvasBox.prototype.draw=function(t){if(!this.canvas)return;const i=this.x,e=-this.y-2*this.h;t.drawImage(this.canvas,this.x,this.y,this.w,this.h),t.save(),t.scale(1,-1),t.drawImage(this.canvas,i,e,this.w,this.h);const s=t.createLinearGradient(0,e,0,e+this.h);s.addColorStop(0,"rgba(255, 255, 255, 1)"),s.addColorStop(1,"rgba(255, 255, 255, 0.5)"),t.fillStyle=s,t.fillRect(this.x,e,this.w,this.h),t.restore()},CoverCanvasBox.prototype.contains=function(t,i){return t>=this.x&&t<=this.x+this.w&&i>=this.y&&i<=this.y+this.h},CoverList.prototype.addElement=function(t){const i={index:this.elements.length,title:"No title",thumb:"",url:""};let e;for(e in t)i[e]=t[e];this.elements.push(i)},CoverList.prototype.initCoverList=function(){this.selected<0?this.selected=Math.floor(this.elements.length/2):this.selected>=this.elements.length&&(this.selected=this.elements.length-1);const t=(this.sliderLabelId?"":'<div id="slider_label" class="sr-only">'+jsu.translate("Images")+"</div>")+'<div class="cover-loading"><i class="loader"></i></div><div class="cover-bar"'+(this.elements.length<2?' style="display: none;"':"")+'><button type="button" class="cover-previous" title="'+jsu.translate("Previous")+'" aria-label="'+jsu.translate("Previous")+'"><b aria-hidden="true">&lt;</b></button><div class="cover-slider"><input type="range" role="slider" aria-labelledby="'+(this.sliderLabelId?this.sliderLabelId:"slider_label")+'" aria-valuemin="0" min="0" aria-valuemax="'+(this.elements.length-1)+'" max="'+(this.elements.length-1)+'" aria-valuenow="'+this.selected+'" value="'+this.selected+'" aria-valuetext=""/></div><button type="button" class="cover-next" title="'+jsu.translate("Next")+'" aria-label="'+jsu.translate("Next")+'"><b aria-hidden="true">&gt;</b></button></div>';this.widgetElement=document.querySelector(this.widgetPlace),this.widgetElement.innerHTML=t,this.widgetElement.classList.add("cover-list"),this.rangeInput=this.widgetElement.querySelector(".cover-slider input"),this.widgetWidth=parseInt(this.widgetElement.clientWidth,10),this.widgetWidth%2!=0&&this.widgetWidth--,this.widgetHeight=parseInt(this.widgetElement.clientHeight,10),this.widgetHeight%2!=0&&this.widgetHeight--,this.calculatePositions();try{this.initCanvas()}catch(t){console.error("Error when trying to initialize cover list.",t)}const i=this;this.widgetElement.querySelector(".cover-previous").addEventListener("click",this.goToPrevious.bind(this)),this.widgetElement.querySelector(".cover-next").addEventListener("click",this.goToNext.bind(this)),this.rangeInput.addEventListener("input",function(){i.goToIndex(this.value)})},CoverList.prototype.calculatePositions=function(){if(0==this.elements.length)this.positions=[];else if(1==this.elements.length){const t=(this.widgetHeight-this.boxHeight)/2+this.yOffset,i=(this.widgetWidth-this.boxWidth)/2;this.positions.push({delta:0,factor:0,width:this.boxWidth,height:this.boxHeight,zindex:1,top:t,offset:i})}else{const t=this.elements.length;let i=1;t<5&&(i=.75,t<3&&(i=.5));for(let e=t;e>=0;e--){const s=t-e;let o=s/t;o=Math.sqrt(o)*i;const h=this.boxWidth*(1-o*this.minSize),n=this.boxHeight*(1-o*this.minSize),a=t-s,l=(this.widgetHeight-n)/2+this.yOffset,r=(this.widgetWidth-h)/2+o*(this.widgetWidth-h)/2;this.positions.push({delta:s,factor:o,width:h,height:n,zindex:a,top:l,offset:r})}}},CoverList.prototype.hideLoading=function(){this.widgetElement.querySelector(".cover-loading").style.display="none"},CoverList.prototype.updateSliderIndex=function(t){this.rangeInput.setAttribute("aria-valuenow",t),this.rangeInput.value=t;const i=this.elements[t].title;this.rangeInput.setAttribute("aria-valuetext",i)},CoverList.prototype.initCanvas=function(){const t=document.createElement("canvas");t.setAttribute("aria-hidden","true"),t.setAttribute("width",this.widgetWidth),t.setAttribute("height",this.widgetHeight),this.widgetElement.insertBefore(t,this.widgetElement.firstChild),this.width=t.width,this.height=t.height,this.ctx=t.getContext("2d"),this.boxes=[],this.boxesDict={},this.nbImagesLoaded=0,this.imagesLoaded=!1;const i=this;t.addEventListener("click",function(e){let s=t,o=0,h=0;for(;null!=s&&null!=s;)o+=s.offsetLeft,h+=s.offsetTop,s=s.offsetParent;const n=e.pageX-o,a=e.pageY-h;i.onCanvasClick(n,a)});for(let t=0;t<this.elements.length;t++){const i=this.elements[t],e=t-this.selected,s=this.positions[Math.abs(e)];let o;o=e<0?this.widgetWidth-s.width-s.offset:s.offset,this.addBox(new CoverCanvasBox({id:t,bw:this.boxWidth,bh:this.boxHeight,padding:this.padding,title:i.title,x:o,y:s.top,w:s.width,h:s.height,z:s.zindex,color:this.color,boxBg:this.boxBg,thumb:i.thumb,url:i.url,callback:this.onImageLoad.bind(this)}))}},CoverList.prototype.onImageLoad=function(){this.nbImagesLoaded++,this.nbImagesLoaded>=this.elements.length&&(this.imagesLoaded=!0,this.hideLoading(),this.drawBoxes())},CoverList.prototype.goToPrevious=function(){this.goToIndex(this.selected-1)},CoverList.prototype.goToNext=function(){this.goToIndex(this.selected+1)},CoverList.prototype.goToIndex=function(t){if(t<0||t>this.elements.length-1||t==this.selected)return;this.selected=t;const i=this.animation.duration/this.animation.interval;for(let t=0;t<this.elements.length;t++){const e=t-this.selected,s=this.positions[Math.abs(e)];let o;o=e<0?this.widgetWidth-s.width-s.offset:s.offset,this.boxesDict["box_"+t].setTarget({steps:i,x:o,y:s.top,w:s.width,h:s.height,z:s.zindex,color:this.color})}this.animateMovement(),this.updateSliderIndex(this.selected)},CoverList.prototype.addBox=function(t){this.boxes.push(t),this.boxesDict["box_"+t.id]=t,t.loadImage()},CoverList.prototype.drawBoxes=function(){this.boxes=this.boxes.sort(function(t,i){return t.z-i.z}),this.ctx.clearRect(0,0,this.width,this.height);for(let t=0;t<this.boxes.length;t++)this.boxes[t].draw(this.ctx)},CoverList.prototype.onCanvasClick=function(t,i){const e=this.boxes.sort(function(t,i){return i.z-t.z});for(let s=0;s<e.length;s++)if(e[s].contains(t,i)){this.selectBox(e[s]);break}},CoverList.prototype.selectBox=function(t){t.id==this.selected?window.location=t.url:this.goToIndex(t.id)},CoverList.prototype.animateMovement=function(){this.animation.currentTime=0,this.animation.timeout=null,this.animateMovementLoop()},CoverList.prototype.animateMovementLoop=function(){if(null!=this.animation.timeout&&(clearTimeout(this.animation.timeout),this.animation.timeout=null),this.animation.currentTime>=this.animation.duration)return;for(let t=0;t<this.boxes.length;t++)this.boxes[t].increment();this.imagesLoaded&&this.drawBoxes(),this.animation.currentTime+=this.animation.interval;const t=this;this.animation.timeout=setTimeout(function(){t.animateMovementLoop()},this.animation.interval)};