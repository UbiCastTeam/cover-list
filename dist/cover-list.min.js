function CoverCanvasBox(t){let i;for(i in this.FIELDS=["padding","x","y","w","h","z"],this.id=0,this.bw=240,this.bh=135,this.padding=3,this.title="",this.titleH=45,this.x=0,this.y=0,this.w=1,this.h=1,this.z=0,this.target={x:0,xStep:0,y:0,yStep:0,w:1,wStep:0,h:1,hStep:0,z:0,zStep:0},this.color="#666",this.boxBg="#fff",this.thumb="",this.url="",this.callback=null,t)this[i]=t[i];this.canvas=null}function CoverList(t){if(this.widgetPlace="#cover_list",this.yOffset=-10,this.padding=3,this.boxWidth=240+2*this.padding,this.boxHeight=135+2*this.padding,this.minSize=.8,this.selected=-1,this.color="#666",this.boxBg="#fff",this.forceHtml=!1,this.sliderLabelId=null,this.$widget=null,this.widgetWidth=0,this.widgetHeight=0,this.elements=[],this.positions=[],this.animation={duration:200,interval:25,currentTime:0},jsu.setObjectAttributes(this,t,["widgetPlace","padding","boxWidth","boxHeight","minSize","selected","color","boxBg","forceHtml","sliderLabelId"]),t&&t.elements)for(let i=0;i<t.elements.length;i++)this.addElement(t.elements[i]);"-"==this.color&&(this.color="transparent");const i=this;$(document).ready(function(){i.initCoverList()})}CoverCanvasBox.prototype.loadImage=function(){if(!this.thumb)return void this.onLoad(null,!1);const t=new Image;if(null!=this.callback){const i=this;t.onload=function(){i.onLoad(this,!0)},t.onabort=function(){i.onLoad(this,!0)},t.onerror=function(){i.onLoad(this,!1)}}t.src=this.thumb},CoverCanvasBox.prototype.onLoad=function(t,i){this.canvas=document.createElement("canvas"),this.canvas.width=this.bw,this.canvas.height=this.bh;const e=this.bw-2*this.padding,s=this.bh-2*this.padding,o=this.canvas.getContext("2d");if(o.fillStyle=this.color,o.fillRect(0,0,this.bw,this.bh),o.fillStyle=this.boxBg,o.fillRect(this.padding,this.padding,e,s),i){const i=t.width/t.height;let h=t.width,n=t.height;h>e&&(h=e,n=e/i),n>s&&(n=s,h=s*i),o.drawImage(t,this.padding+Math.floor((e-h)/2),this.padding+Math.floor((s-n)/2),h,n)}if(this.title){o.fillStyle="rgba(0, 0, 0, 0.7)",o.fillRect(this.padding,this.padding+s-this.titleH,e,this.titleH);const t=16;o.font="italic "+t+"px Arial",o.fillStyle="#fff",o.textAlign="center",o.textBaseline="middle";const i=this.padding+Math.floor(e/2);let h;const n=e-10;let a="",l="",r=!0;if(o.measureText(this.title).width>n){const t=this.title.split(" ");let i=t.length;for(let e=0;e<i;e++){const i=t[0];if(o.measureText(a+" "+i).width>n){if(!a)for(let t=0;t<i.length;t++){if(o.measureText(a+i[t]).width>n-20){a+=" ...",r=!1;break}a+=i[t]}break}a+=" "+i,t.shift()}if(r){i=t.length;for(let e=0;e<i;e++){const i=t[0];if(o.measureText(l+" "+i).width>n-20){if(l)l+=" ...";else for(let t=0;t<i.length;t++){if(o.measureText(l+i[t]).width>n-20){l+=" ...";break}l+=i[t]}break}l+=" "+i,t.shift()}}}else a=this.title;a&&l?(h=this.padding+s-Math.floor((this.titleH+t)/2),o.fillText(a,i,h),h+=4+t,o.fillText(l,i,h)):(h=this.padding+s-Math.floor(this.titleH/2),o.fillText(a,i,h))}o.save(),null!=this.callback&&this.callback(this.id,!1)},CoverCanvasBox.prototype.setTarget=function(t){const i=t.steps?t.steps:50;for(let e=0;e<this.FIELDS.length;e++){const s=this.FIELDS[e];s in t?(this.target[s]=t[s],this.target[s+"_step"]=(this.target[s]-this[s])/i):(this.target[s]=this[s],this.target[s+"_step"]=0)}},CoverCanvasBox.prototype.increment=function(){for(let t=0;t<this.FIELDS.length;t++){const i=this.FIELDS[t];this[i]!=this.target[i]&&(this[i]+=this.target[i+"_step"])}},CoverCanvasBox.prototype.draw=function(t){if(!this.canvas)return;const i=this.x,e=-this.y-2*this.h;t.drawImage(this.canvas,this.x,this.y,this.w,this.h),t.save(),t.scale(1,-1),t.drawImage(this.canvas,i,e,this.w,this.h);const s=t.createLinearGradient(0,e,0,e+this.h);s.addColorStop(0,"rgba(255, 255, 255, 1)"),s.addColorStop(1,"rgba(255, 255, 255, 0.5)"),t.fillStyle=s,t.fillRect(this.x,e,this.w,this.h),t.restore()},CoverCanvasBox.prototype.contains=function(t,i){return t>=this.x&&t<=this.x+this.w&&i>=this.y&&i<=this.y+this.h},CoverList.prototype.addElement=function(t){const i={index:this.elements.length,title:"No title",thumb:"",url:""};let e;for(e in t)i[e]=t[e];this.elements.push(i)},CoverList.prototype.initCoverList=function(){let t="";if(t+='<span class="cover-loading"><i class="fa fa-spin fa-refresh fa-3x"></i></span>',this.sliderLabelId||(this.sliderLabelId="slider_label",t+='<span id="'+this.sliderLabelId+'" class="sr-only">'+jsu.translate("Images")+"</span>"),t+='<div class="cover-bar">',t+='    <button type="button" class="cover-previous" title="'+jsu.translate("Previous")+'" aria-label="'+jsu.translate("Previous")+'"><i aria-hidden="true" class="fa fa-angle-left"></i></button>',t+='    <div class="cover-slider" role="slider" aria-labelledby="'+this.sliderLabelId+'" aria-valuemin="0" aria-valuemax="'+(this.elements.length-1)+'" aria-valuenow="1" aria-valuetext=""></div>',t+='    <button type="button" class="cover-next" title="'+jsu.translate("Next")+'" aria-label="'+jsu.translate("Next")+'"><i aria-hidden="true" class="fa fa-angle-right"></i></button>',t+="</div>",this.$widget=$(this.widgetPlace),this.$widget.html(t).addClass("cover-list"),this.widgetWidth=parseInt(this.$widget.width(),10),this.widgetWidth%2!=0&&this.widgetWidth--,this.widgetHeight=parseInt(this.$widget.height(),10),this.widgetHeight%2!=0&&this.widgetHeight--,this.calculatePositions(),this.selected<0?this.selected=Math.floor(this.elements.length/2):this.selected>=this.elements.length&&(this.selected=this.elements.length-1),this.mode=null,!this.forceHtml)try{this.canvasCoverInit(),this.mode="canvas"}catch(t){}this.mode||(this.htmlCoverInit(),this.mode="html"),this.elements.length<2?$(".cover-bar",this.$widget).css("display","none"):$(".cover-bar",this.$widget).css("display","block");const i=this;$(".cover-previous",this.$widget).click({obj:this},function(t){return t.data.obj.goToPrevious(),!1}),$(".cover-next",this.$widget).click({obj:this},function(t){return t.data.obj.goToNext(),!1}),$(".cover-slider",this.$widget).slider({min:0,max:this.elements.length-1,value:this.selected,slide:function(t,e){i.goToIndex(e.value)},stop:function(t,e){i.goToIndex(e.value)}})},CoverList.prototype.calculatePositions=function(){if(0==this.elements.length)this.positions=[];else if(1==this.elements.length){const t=(this.widgetHeight-this.boxHeight)/2+this.yOffset,i=(this.widgetWidth-this.boxWidth)/2;this.positions.push({delta:0,factor:0,width:this.boxWidth,height:this.boxHeight,zindex:1,top:t,offset:i})}else{const t=this.elements.length;let i=1;t<5&&(i=.75,t<3&&(i=.5));for(let e=t;e>=0;e--){const s=t-e;let o=s/t;o=Math.sqrt(o)*i;const h=this.boxWidth*(1-o*this.minSize),n=this.boxHeight*(1-o*this.minSize),a=t-s,l=(this.widgetHeight-n)/2+this.yOffset,r=(this.widgetWidth-h)/2+o*(this.widgetWidth-h)/2;this.positions.push({delta:s,factor:o,width:h,height:n,zindex:a,top:l,offset:r})}}},CoverList.prototype.goToIndex=function(t){"canvas"==this.mode?this.canvasCoverGoToIndex(t):this.htmlCoverGoToIndex(t)},CoverList.prototype.goToPrevious=function(){"canvas"==this.mode?this.canvasCoverGoToIndex(this.selected-1):this.htmlCoverGoToIndex(this.selected-1)},CoverList.prototype.goToNext=function(){"canvas"==this.mode?this.canvasCoverGoToIndex(this.selected+1):this.htmlCoverGoToIndex(this.selected+1)},CoverList.prototype.hideLoading=function(){$(".cover-loading",this.$widget).css("display","none")},CoverList.prototype.updateSliderIndex=function(t){$(".cover-slider",this.$widget).attr("aria-valuenow",t),$(".cover-slider",this.$widget).slider("value",t);const i=this.elements[t].title;$(".cover-slider",this.$widget).attr("aria-valuetext",i)},CoverList.prototype.htmlCoverInit=function(){this.hideLoading();const t="border-color: "+this.color+"; background: "+this.boxBg+";";for(let i=0;i<this.elements.length;i++){const e=this.elements[i],s=i-this.selected,o=this.positions[Math.abs(s)];let h="top: "+o.top+"px; ";h+=s<0?"left: "+(this.widgetWidth-o.width-o.offset)+"px;":"left: "+o.offset+"px;";let n='<div class="cover-box" id="cover_box_'+i+'" style="'+("width: "+o.width+"px; height: "+o.height+"px; font-size: "+Math.floor(100*(1-o.factor))+"%; z-index: "+o.zindex+"; "+h)+'">';n+='<div class="cover-box-content" style="'+t+'">',n+='<img src="'+e.thumb+'" alt="'+e.title+'"/>',e.title&&(n+="<div>"+e.title+"</div>"),n+="</div>",n+="</div>",(n=$(n)).click({obj:this,index:i},function(t){t.data.obj.htmlCoverSelect(t.data.index)}),this.$widget.append(n)}},CoverList.prototype.htmlCoverSelect=function(t){t==this.selected?window.location=this.elements[t].url:this.htmlCoverGoToIndex(t)},CoverList.prototype.htmlCoverGoToIndex=function(t){if(!(t<0||t>this.elements.length-1||t==this.selected)){this.selected=t;for(let t=0;t<this.elements.length;t++){const i=t-this.selected,e=this.positions[Math.abs(i)],s={top:e.top,width:e.width,height:e.height};s.left=i<0?this.widgetWidth-e.width-e.offset:e.offset;const o=$("#cover_box_"+t,this.$widget);o.stop(!0,!1),o.css("z-index",e.zindex),o.css("font-size",Math.floor(100*(1-e.factor))+"%"),o.animate(s,500)}this.updateSliderIndex(this.selected)}},CoverList.prototype.canvasCoverInit=function(){this.$canvas=$('<canvas aria-hidden="true" width="'+this.widgetWidth+'" height="'+this.widgetHeight+'"></canvas>'),this.$widget.prepend(this.$canvas),this.canvas=this.$canvas[0],this.width=this.canvas.width,this.height=this.canvas.height,this.ctx=this.canvas.getContext("2d"),this.boxes=[],this.boxesDict={},this.nbImagesLoaded=0,this.imagesLoaded=!1,$(this.canvas).click({obj:this},function(t){let i=t.data.obj.canvas,e=0,s=0;for(;null!=i&&null!=i;)e+=i.offsetLeft,s+=i.offsetTop,i=i.offsetParent;const o=t.pageX-e,h=t.pageY-s;t.data.obj.canvasCoverOnClick(o,h)});const t=this,i=function(i){t.canvasCoverOnImageLoad(i)};for(let t=0;t<this.elements.length;t++){const e=this.elements[t],s=t-this.selected,o=this.positions[Math.abs(s)];let h;h=s<0?this.widgetWidth-o.width-o.offset:o.offset,this.canvasCoverAddBox(new CoverCanvasBox({id:t,bw:this.boxWidth,bh:this.boxHeight,padding:this.padding,title:e.title,x:h,y:o.top,w:o.width,h:o.height,z:o.zindex,color:this.color,boxBg:this.boxBg,thumb:e.thumb,url:e.url,callback:i}))}},CoverList.prototype.canvasCoverOnImageLoad=function(){this.nbImagesLoaded++,this.nbImagesLoaded>=this.elements.length&&(this.imagesLoaded=!0,this.hideLoading(),this.canvasCoverDraw())},CoverList.prototype.canvasCoverGoToIndex=function(t){if(t<0||t>this.elements.length-1||t==this.selected)return;this.selected=t;const i=this.animation.duration/this.animation.interval;for(let t=0;t<this.elements.length;t++){const e=t-this.selected,s=this.positions[Math.abs(e)];let o;o=e<0?this.widgetWidth-s.width-s.offset:s.offset,this.boxesDict["box_"+t].setTarget({steps:i,x:o,y:s.top,w:s.width,h:s.height,z:s.zindex,color:this.color})}this.canvasCoverAnimate(),this.updateSliderIndex(this.selected)},CoverList.prototype.canvasCoverAddBox=function(t){this.boxes.push(t),this.boxesDict["box_"+t.id]=t,t.loadImage()},CoverList.prototype.canvasCoverDraw=function(){this.boxes=this.boxes.sort(function(t,i){return t.z-i.z}),this.ctx.clearRect(0,0,this.width,this.height);for(let t=0;t<this.boxes.length;t++)this.boxes[t].draw(this.ctx)},CoverList.prototype.canvasCoverOnClick=function(t,i){const e=this.boxes.sort(function(t,i){return i.z-t.z});for(let s=0;s<e.length;s++)if(e[s].contains(t,i)){this.canvasCoverSelect(e[s]);break}},CoverList.prototype.canvasCoverSelect=function(t){t.id==this.selected?window.location=t.url:this.canvasCoverGoToIndex(t.id)},CoverList.prototype.canvasCoverAnimate=function(){this.animation.currentTime=0,this.animation.timeout=null,this.canvasCoverAnimateLoop()},CoverList.prototype.canvasCoverAnimateLoop=function(){if(null!=this.animation.timeout&&(clearTimeout(this.animation.timeout),this.animation.timeout=null),this.animation.currentTime>=this.animation.duration)return;for(let t=0;t<this.boxes.length;t++)this.boxes[t].increment();this.imagesLoaded&&this.canvasCoverDraw(),this.animation.currentTime+=this.animation.interval;const t=this;this.animation.timeout=setTimeout(function(){t.canvasCoverAnimateLoop()},this.animation.interval)};